use crate::common::loki_error::loki_error::LokiError;

pub struct Xorer {}

impl Xorer {
    const MAX_UNIT_LEN: usize = 1500;

    const XOR_KEY: [u8; Self::MAX_UNIT_LEN] = [
        164, 2, 117, 99, 249, 205, 70, 88, 53, 220, 48, 167, 198, 82, 130, 250, 157, 143, 55, 126,
        236, 9, 24, 251, 133, 73, 247, 218, 196, 96, 85, 232, 174, 121, 93, 143, 147, 136, 5, 13,
        254, 86, 138, 55, 190, 74, 199, 151, 205, 93, 78, 120, 128, 244, 18, 118, 199, 192, 80, 27,
        203, 44, 97, 146, 171, 42, 48, 253, 58, 155, 88, 175, 207, 24, 9, 191, 24, 0, 115, 15, 222,
        97, 67, 203, 34, 83, 220, 180, 229, 53, 212, 103, 195, 157, 71, 100, 111, 254, 206, 217,
        154, 243, 25, 187, 238, 193, 191, 53, 162, 253, 65, 105, 231, 199, 199, 102, 161, 195, 0,
        41, 47, 9, 200, 212, 93, 35, 57, 57, 204, 70, 222, 208, 68, 249, 169, 136, 251, 12, 28,
        201, 34, 141, 255, 50, 219, 196, 104, 184, 230, 17, 6, 77, 110, 162, 120, 56, 213, 192, 39,
        169, 46, 251, 103, 222, 172, 133, 96, 187, 169, 10, 1, 83, 73, 183, 122, 152, 246, 172, 62,
        39, 135, 118, 81, 168, 215, 184, 126, 126, 122, 179, 243, 173, 200, 189, 215, 231, 80, 31,
        187, 52, 48, 174, 137, 126, 119, 69, 105, 203, 242, 60, 124, 51, 66, 129, 233, 66, 128, 96,
        210, 64, 224, 91, 46, 90, 59, 109, 70, 144, 191, 249, 217, 118, 84, 218, 165, 171, 131,
        124, 27, 221, 169, 141, 4, 139, 198, 119, 195, 123, 133, 207, 237, 193, 151, 125, 203, 153,
        144, 167, 102, 31, 65, 182, 34, 189, 173, 16, 135, 22, 226, 32, 175, 247, 66, 69, 247, 91,
        3, 75, 240, 84, 80, 162, 132, 249, 69, 241, 203, 21, 110, 210, 94, 57, 209, 243, 177, 54,
        103, 39, 220, 131, 127, 172, 182, 19, 124, 49, 242, 52, 68, 126, 118, 175, 190, 85, 71, 31,
        98, 157, 172, 183, 73, 243, 233, 41, 193, 166, 195, 237, 58, 25, 145, 127, 204, 9, 163,
        135, 140, 41, 203, 150, 107, 217, 11, 248, 233, 60, 197, 148, 19, 134, 199, 154, 16, 44,
        31, 1, 115, 228, 182, 239, 44, 50, 27, 22, 23, 79, 57, 139, 162, 247, 87, 48, 238, 224, 64,
        57, 28, 194, 60, 140, 24, 20, 37, 135, 37, 73, 96, 33, 168, 169, 34, 5, 157, 122, 100, 130,
        218, 85, 104, 50, 233, 132, 120, 94, 170, 21, 217, 215, 164, 123, 174, 204, 123, 176, 107,
        196, 226, 36, 132, 72, 195, 216, 39, 209, 128, 165, 186, 44, 194, 153, 45, 9, 255, 186,
        232, 105, 26, 57, 206, 90, 207, 82, 249, 173, 131, 8, 194, 54, 201, 55, 220, 131, 240, 27,
        171, 128, 209, 192, 244, 243, 129, 216, 158, 220, 230, 43, 164, 226, 38, 167, 151, 83, 206,
        7, 194, 189, 52, 10, 190, 189, 172, 224, 16, 86, 248, 111, 113, 80, 229, 91, 120, 16, 217,
        0, 169, 108, 58, 112, 51, 147, 78, 128, 198, 236, 88, 200, 94, 96, 81, 177, 44, 181, 46,
        98, 215, 27, 190, 50, 221, 133, 110, 141, 164, 131, 175, 194, 134, 156, 190, 196, 153, 248,
        2, 196, 163, 48, 83, 239, 220, 65, 54, 249, 216, 252, 237, 85, 150, 164, 76, 48, 239, 102,
        107, 126, 139, 122, 5, 109, 89, 101, 12, 59, 45, 217, 143, 218, 112, 226, 211, 100, 213,
        136, 15, 156, 235, 73, 55, 99, 153, 91, 89, 72, 200, 195, 104, 75, 226, 158, 166, 66, 72,
        114, 219, 78, 253, 91, 66, 51, 244, 18, 99, 180, 21, 213, 184, 7, 174, 52, 239, 68, 34,
        103, 189, 118, 243, 11, 169, 59, 105, 189, 54, 134, 177, 245, 53, 252, 101, 200, 153, 48,
        183, 59, 205, 117, 212, 125, 244, 145, 110, 154, 34, 126, 110, 252, 130, 227, 15, 129, 180,
        49, 32, 16, 165, 179, 235, 40, 137, 203, 181, 107, 192, 56, 152, 142, 219, 49, 196, 201,
        14, 41, 208, 238, 183, 138, 187, 53, 48, 108, 139, 79, 8, 252, 237, 200, 33, 204, 177, 22,
        130, 132, 59, 226, 228, 55, 83, 134, 175, 92, 42, 4, 98, 17, 10, 96, 114, 44, 224, 37, 17,
        89, 170, 208, 32, 182, 17, 32, 54, 24, 227, 107, 177, 41, 186, 12, 90, 152, 7, 41, 5, 64,
        64, 114, 50, 235, 111, 109, 22, 139, 244, 20, 156, 100, 160, 47, 240, 120, 66, 114, 138,
        121, 44, 140, 32, 207, 196, 128, 170, 71, 205, 148, 174, 96, 204, 82, 167, 41, 109, 239,
        248, 151, 24, 120, 32, 81, 59, 48, 91, 195, 1, 64, 24, 191, 70, 83, 116, 97, 6, 23, 71,
        115, 37, 84, 176, 83, 48, 161, 121, 183, 219, 71, 186, 47, 92, 208, 71, 0, 137, 10, 181,
        221, 208, 60, 29, 129, 46, 94, 44, 180, 38, 77, 6, 83, 163, 168, 141, 147, 123, 227, 208,
        134, 44, 115, 81, 152, 167, 17, 131, 157, 69, 188, 47, 22, 126, 50, 133, 194, 228, 89, 80,
        200, 161, 117, 23, 140, 29, 65, 244, 245, 148, 15, 152, 136, 68, 246, 150, 62, 118, 87, 97,
        191, 29, 55, 125, 72, 152, 191, 41, 31, 251, 254, 144, 230, 211, 30, 220, 251, 213, 191, 3,
        89, 196, 208, 215, 245, 93, 197, 242, 41, 148, 123, 7, 83, 162, 100, 247, 25, 17, 87, 48,
        157, 86, 179, 254, 186, 128, 11, 149, 170, 203, 100, 245, 108, 144, 220, 49, 97, 14, 65,
        228, 208, 126, 114, 9, 71, 155, 160, 158, 44, 41, 126, 146, 134, 23, 187, 22, 110, 153,
        228, 165, 139, 82, 65, 182, 116, 105, 240, 252, 164, 83, 222, 38, 40, 77, 158, 73, 224, 67,
        12, 74, 94, 161, 204, 23, 104, 113, 12, 203, 102, 24, 232, 109, 98, 228, 138, 140, 194,
        182, 44, 41, 44, 184, 225, 224, 232, 196, 19, 219, 16, 191, 63, 4, 52, 35, 76, 248, 104,
        67, 247, 152, 13, 241, 205, 50, 10, 202, 82, 241, 20, 240, 130, 118, 85, 31, 255, 138, 148,
        97, 230, 116, 218, 211, 39, 152, 91, 254, 179, 73, 198, 64, 177, 157, 66, 85, 36, 111, 31,
        206, 23, 122, 68, 26, 167, 67, 16, 106, 137, 46, 52, 252, 215, 104, 134, 136, 83, 8, 241,
        221, 77, 190, 12, 132, 22, 92, 193, 132, 235, 93, 62, 218, 82, 36, 39, 173, 3, 13, 41, 56,
        254, 164, 238, 151, 37, 151, 135, 141, 55, 249, 109, 106, 76, 124, 238, 4, 243, 161, 86,
        131, 100, 126, 179, 198, 202, 83, 17, 97, 239, 150, 87, 110, 95, 42, 29, 43, 249, 108, 223,
        92, 205, 249, 96, 192, 112, 231, 208, 212, 97, 27, 143, 67, 80, 236, 70, 107, 107, 149,
        191, 168, 40, 144, 16, 185, 160, 45, 35, 174, 124, 117, 22, 59, 107, 230, 95, 112, 0, 38,
        120, 123, 61, 81, 33, 246, 84, 8, 87, 118, 75, 231, 251, 227, 140, 7, 242, 23, 215, 40, 42,
        69, 88, 151, 111, 246, 119, 83, 162, 220, 236, 169, 54, 147, 252, 130, 55, 49, 158, 198,
        160, 1, 140, 132, 120, 112, 252, 79, 250, 2, 112, 120, 193, 71, 37, 227, 206, 110, 141,
        231, 17, 137, 129, 215, 13, 37, 251, 239, 189, 230, 100, 43, 82, 34, 67, 142, 109, 197, 94,
        207, 114, 135, 102, 172, 39, 47, 154, 220, 196, 3, 64, 188, 46, 117, 60, 45, 175, 170, 158,
        177, 125, 83, 143, 67, 208, 7, 199, 148, 57, 35, 66, 120, 179, 93, 168, 95, 61, 200, 175,
        164, 127, 217, 225, 74, 88, 239, 222, 236, 222, 193, 235, 146, 204, 31, 191, 186, 35, 196,
        172, 99, 138, 247, 14, 217, 225, 23, 26, 157, 6, 208, 53, 100, 68, 143, 220, 129, 120, 157,
        0, 161, 7, 142, 117, 11, 161, 111, 127, 95, 251, 18, 162, 152, 201, 238, 101, 209, 228, 28,
        246, 222, 122, 6, 139, 228, 67, 231, 196, 202, 141, 112, 38, 158, 63, 139, 157, 44, 204,
        70, 97, 20, 4, 106, 252, 176, 225, 173, 57, 212, 167, 222, 9, 144, 189, 154, 29, 51, 143,
        174, 169, 173, 5, 176, 249, 119, 138, 226, 104, 197, 197, 249, 117, 140, 0, 237, 78, 214,
        88, 123, 62, 167, 24, 74, 180, 8, 71, 100, 75, 161, 6, 155, 152, 197, 206, 42, 2, 226, 203,
        200, 102, 34, 241, 174, 175, 115, 19, 214, 22, 139, 56, 163, 159, 154, 61, 83, 184, 162,
        122, 90, 120, 92, 1, 189, 86, 226, 222, 129, 67, 68, 210, 24, 222, 233, 100, 152, 36, 130,
        246, 37, 195, 157, 244, 143, 47, 211, 150, 48, 49, 119, 157, 115, 18, 166, 225, 186, 190,
        83, 79, 191, 181, 140, 196, 240, 135, 252, 44, 137, 212, 101, 203, 53, 200, 158, 103, 97,
        53,
    ];

    //xor - like encript
    #[inline(always)]
    pub fn xor(val: &mut Vec<u8>) -> Option<LokiError> {
        let err = Self::xor_operation(val);
        if err.is_some() {
            return err;
        }
        val.reverse();

        return None;
    }

    //xor - like encript
    #[inline(always)]
    fn xor_operation(val: &mut Vec<u8>) -> Option<LokiError> {
        if val.len() > Self::MAX_UNIT_LEN {
            return Some(LokiError::XORLenOverflow);
        }

        let max_idx = Self::MAX_UNIT_LEN - 1;

        for (index, value) in val.iter_mut().enumerate() {
            *value ^= Self::XOR_KEY[max_idx - index];
        }

        return None;
    }

    //un_xor like decript and check is ipv4
    #[inline(always)]
    pub fn un_xor_verify(val: &mut Vec<u8>) -> Option<LokiError> {
        val.reverse();
        let err = Self::xor_operation(val);
        if err.is_some() {
            return err;
        }
        if !Self::is_ipv4_packet(val) {
            return Some(LokiError::XORIpv4VerifyFail);
        }

        return None;
    }

    #[inline(always)]
    fn is_ipv4_packet(buf: &Vec<u8>) -> bool {
        if buf.len() < 20 {
            return false;
        }

        let vihl = buf[0];
        let version = vihl >> 4;
        let ihl = vihl & 0x0F;

        if version != 4 || ihl < 5 {
            return false;
        }

        let header_len = (ihl as usize) << 2;

        if header_len > buf.len() {
            return false;
        }

        let total_len = u16::from_be_bytes([buf[2], buf[3]]) as usize;

        total_len >= header_len && total_len <= buf.len()
    }
}
